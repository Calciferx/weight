<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>按钮管理</title>
    <!--第三方css-->
    <link rel="stylesheet" href="_plugin/layui/css/layui.css">
    <link rel="stylesheet" href="_plugin/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="_plugin/zTree/css/bootstrapStyle/bootstrapStyle.css">
    <link rel="stylesheet" href="_plugin/fontawesome/css/all.css">
    <!--自定义css-->
    <link rel="stylesheet" href="_css/main.css">
    <style>
        form.bodyGrid {
            grid-template-columns: 1fr 320px;
            grid-template-areas: "header aside" "main aside";
            z-index: 0;
            padding: 10px 15px;
        }

        form.bodyGrid > aside {
            padding: 10px 40px;
            border-radius: 10px;
        }

        form.bodyGrid > aside .col-12 {
            border-bottom: 1px dashed #e5e5e5;
            padding-bottom: 6px;
            margin-bottom: 6px;
        }

        form.bodyGrid > aside button i.fal {
            display: none;
        }
    </style>
</head>
<body>

<!--主框架-->
<div class="bodyGrid bodyGrid_ahm">
    <header>
        <div class="btnBar">
            <div class="btn-group">
                <button class="btn btn_insert">新增</button>
                <button class="btn btn_update">修改</button>
                <button class="btn btn_delete">删除</button>
            </div>
        </div>
    </header>
    <aside>
        <ul class="ztree" id="menuTree"></ul>
    </aside>
    <main>
        <table class="layui-table" id="dataTable" lay-filter="dataTable" ignore></table>
    </main>
</div>

<!--副框架-->
<form class="layui-form bodyGrid" id="formInsert" lay-filter="formInsert">
    <header>
        <div class="btnBar">
            <div class="btn-group btn-group-sm">
                <button class="btn_submit" lay-submit lay-filter="btn_submit">保存</button>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn_submit_new" lay-submit lay-filter="btn_submit_new">保存新增</button>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn_return">返回</button>
            </div>
        </div>
    </header>
    <main>
        <div class="form-row">
            <div hidden>
                <input name="eName" title="英文名称">
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">菜单项</label>
                    <div class="col-8">
                        <input class="form-control diySelect menuSelect" name="menuName" data-id="menuName"
                               lay-verify="required">
                        <input name="menuId" title="菜单id">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">Class</label>
                    <div class="col-8">
                        <input class="form-control" name="code" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">名称</label>
                    <div class="col-8">
                        <input class="form-control" name="name" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">排序</label>
                    <div class="col-8">
                        <input class="form-control" name="sort" type="number" min="1" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="form-group form-row">
                    <label class="col-2 col-form-label">备注</label>
                    <div class="col-10">
                        <textarea class="form-control" name="remark"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <aside>
        <div class="row">
            <div class="col-12">
                <button type="button" class="btn btn-link" data-class="btn_insert" data-sort="11">
                    <i class="fal fa-plus"></i> 新增
                </button>
                <button type="button" class="btn btn-link" data-class="btn_update" data-sort="12">
                    <i class="fal fa-pencil"></i> 修改
                </button>
                <button type="button" class="btn btn-link" data-class="btn_delete" data-sort="13">
                    <i class="fal fa-trash"></i> 删除
                </button>
                <button type="button" class="btn btn-link" data-class="btn_copy" data-sort="14">
                    <i class="fal fa-files-o"></i> 复制
                </button>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-link" data-class="btn_select" data-sort="21">
                    <i class="fal fa-search"></i> 查询
                </button>
            </div>
            <div class="col-12">

                <button type="button" class="btn btn-link" data-class="btn_verify" data-sort="31">
                    <i class="fal fa-check-square-o"></i> 审批
                </button>
                <button type="button" class="btn btn-link" data-class="btn_freeze" data-sort="32">
                    <i class="fal fa-snowflake-o"></i> 冻结
                </button>
                <button type="button" class="btn btn-link" data-class="btn_filter" data-sort="39">
                    <i class="fal fa-filter"></i> 过滤
                </button>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-link" data-class="btn_search" data-sort="81">
                    <i class="fal fa-search"></i> 模糊搜索
                </button>
            </div>
            <div class="col-12">
                <button type="button" class="btn btn-link" data-class="btn_import" data-sort="91">
                    <i class="fal fa-upload"></i> 导入
                </button>
                <button type="button" class="btn btn-link" data-class="btn_export" data-sort="92">
                    <i class="fal fa-download"></i> 导出
                </button>
                <button type="button" class="btn btn-link" data-class="btn_print" data-sort="93">
                    <i class="fal fa-print"></i> 打印
                </button>
                <button type="button" class="btn btn-link" data-class="btn_more" data-sort="99">
                    <i class="fal fa-print"></i> 更多
                </button>
            </div>
        </div>
    </aside>
</form>

<!--第三方js-->
<script src="_plugin/jquery/jquery-3.3.1.min.js"></script>
<script src="_plugin/bootstrap/js/bootstrap.min.js"></script>
<script src="_plugin/layui/layui.all.js"></script>
<script src="_plugin/zTree/js/jquery.ztree.all.min.js"></script>
<!--自定义js-->
<script src="_js/main.js"></script>
<script src="_js/tree_menu.js"></script>
<script>
    $(function () {
        getTree()
    })
</script>
<script>
    // 渲染树
    function getTree() {
        $.post(
            '../sys/menu/listAll.do',
            {
                token: token,
            },
            function (data) {
                if (data.code != 1111) {
                    layer.msg(data.msg)
                    return false
                }
                data = data.data ? data.data : []
                $.each(data, function () {
                    this.pId = this.pid
                    this.open = true
                    this.isParent = this.type == 1 ? false : true
                    delete this.url
                    delete this.icon
                })
                data.unshift({id: 0, name: '菜单', isParent: true, open: true})
                $.fn.zTree.init($('#menuTree'), setting, data);
                $('#menuTree_1_a').click()
            }
        )
    }

    var setting = {
        view: {
            // showIcon: false
        },
        data: {
            simpleData: {
                enable: true
            }
        },
        callback: {
            onClick: zTreeOnClick,//点击触发
        }
    }

    //节点被点击时触发, 改变复选框状态
    function zTreeOnClick(event, treeId, treeNode) {
        datasl.menuId = treeNode.id
        datasl.menuName = treeNode.name
        getTable()
    }
</script>
<script>
    // 渲染表格
    function getTable() {
        datasl.token = token
        laytable.render({
            elem: '#dataTable',
            url: '../adminx/button/listAllByMenuId',
            where: datasl,
            method: 'post',
            headers: {token: token},
            height: 'full-105',  //设定高度-差值
            cols: [[
                {width: 46, type: 'radio', fixed: 'left'},
                {title: '排序', field: 'sort'},
                {title: 'Class', field: 'code'},
                {title: '名称', field: 'name', event: 'detail'},
                {title: '备注', field: 'remark'},
            ]],
            response: {
                statusCode: 1111  //规定成功状态码，table 组件默认为 0
            },
            parseData: function (res) { //表格渲染前的数据预处理
                return {
                    code: res.code,    //解析接口状态
                    msg: res.msg,      //解析提示文本,当code与statusCode不等(即失败)时提示
                    count: res.total,  //解析数据长度
                    data: res.data     //解析数据列表
                };
            },
            done: function (res) {
                done_table(res)   //加载表格后的处理
            }
        })
    }
</script>
<script>
    // 获取详细信息
    function getDetail() {
        console.log(thistr)
        thistr.menuName = datasl.menuName
        layform.val('formInsert', thistr)

        //当前表单数据(暂存, 修改页点击返回时判断是否有改动)(放在最后)
        thisform = layform.val('formInsert')
    }

    //监听修改按钮
    $('.btn_update').click(function () {
        if (!$('body').attr('thisdo')) {
            let i = $('tr.checked').attr('data-index')
            checkeds = i == null ? [] : [thistable[i]]  //获取选中数据(单选框、无选框)

            if (!checkeds.length) {
                layer.msg('请选择一条数据')
                return false
            }
            thistr = checkeds[0]
        }
        to_update() //前往修改
    })

    /*=========================================================*/
    // 监听新增按钮
    $('.btn_insert').click(function () {
        let menuTree = $.fn.zTree.getZTreeObj('menuTree')
        let nodes = menuTree.getSelectedNodes()[0]
        if (nodes.type == 1) {
            setTimeout(() => {
                $('#formInsert [name="menuName"]').val(nodes.name)
                $('#formInsert [name="menuId"]').val(nodes.id)
                thisform = layform.val('formInsert')   //当前表单数据(暂存, 点击返回时判断是否有改动)
            }, 100)
        }
    })

    // 监听删除按钮
    $('.btn_delete').click(function () {
        if (!$('body').attr('thisdo')) {
            let i = $('tr.checked').attr('data-index')
            checkeds = i == null ? [] : [thistable[i]]  //获取选中数据(单选框、无选框)

            if (!checkeds.length) {
                layer.msg('请选择一条数据')
                return false
            }
        }

        $.post(
            '../adminx/button/delete',
            {
                token,
                buttonId: checkeds.map(item => item.id).join(',')
            },
            res => {
                done(res)   //常规操作后的处理
            }
        )
    })

    /*=========================================================*/
    //保存_执行 (表单内容, 按钮名称)
    function doSubmit(field, btn) {
        field.token = token

        var url = '../adminx/button/add'
        if ($('body').attr('thisdo') == 'update') {//如果是修改
            url = '../adminx/button/update'
            field.buttonId = thistr.id
        }
        $.post(
            url,
            field,
            res => {
                done_submit(res, btn)   //保存后的处理
            }
        )
    }
</script>
<script>
    $('#formInsert aside button').click(function () {
        $('#formInsert [name="name"]').val($(this).text().trim())
        $('#formInsert [name="code"]').val($(this).attr('data-class'))
        $('#formInsert [name="sort"]').val($(this).attr('data-sort'))
    })
</script>
</body>
</html>