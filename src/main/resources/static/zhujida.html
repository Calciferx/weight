<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <!--第三方css-->
    <link rel="stylesheet" href="_plugin/layui/css/layui.css">
    <link rel="stylesheet" href="_plugin/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="_plugin/zTree/css/bootstrapStyle/bootstrapStyle.css">

    <!--自定义css-->
    <link rel="stylesheet" href="_css/main.css">

</head>
<style>
    /*上传图片重写---------------------------------------------*/
    .imgBox {
        width: 60px;
        height: 60px;
        background-image: url("_img/main/upload.png");
    }

    .imgBox:not(.addImgs) {
        border: 1px #e5e5e5 solid;
    }

    body[thisdo="detail"] .addImgs {
        display: none;
    }

    .addImgs {
        width: 60px;
        height: 60px;
    }

    .btn_publish {
        line-height: 38px;
    }

    .btnTds {
        line-height: 35px;
    }
</style>
<body>
<!--主框架-->
<div class="bodyGrid">
    <header>
        <div class="btnBar">
            <div class="btn-group">
                <button class="btn btn-info btn_insert">新增</button>
                <button class="btn btn-info btn_update">修改</button>
                <button class="btn btn-info btn_delete">删除</button>
            </div>
            <!--<div class="btn-group">
                <button class="btn_select" w="360" h="250">查询</button>
            </div>-->
            <div class="btn-group">
                <button class="btn_freeze">停用</button>
                <dropdown>
                    <button class="dropdown-toggle"></button>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a href="##" class="dropdown-item btn_active">启用</a>
                    </div>
                </dropdown>
                <dropdown>
                    <button class="btn_filter dropdown-toggle">过滤</button>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a href="##" class="dropdown-item custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="check_showAll">
                            <label class="custom-control-label" for="check_showAll">显示停用</label>
                        </a>
                    </div>
                </dropdown>
            </div>

        </div>
        <div class="btnBar">
            <div class="btn-group">
                <dropdown>
                    <button class="btn_search">模糊搜索</button>
                    <div class="dropdown-menu dropdown-menu-right">
                        <div class="input-group">
                            <input class="form-control" data-id="keywords" data-name="keywords">
                            <div class="input-group-append">
                                <a href="##" class="btn_search_do">模糊搜索</a>
                            </div>
                        </div>
                    </div>
                </dropdown>
            </div>
            <div class="btn-group">
                <!--				<button class="btn_import">导入</button>-->
                <button class="btn_export" do-ignore>导出</button>
                <button class="btn_print">打印</button>
            </div>
        </div>
    </header>
    <main>
        <table class="layui-table" id="dataTable" lay-filter="dataTable"></table>
    </main>
</div>

<!--副框架-->
<form class="layui-form bodyGrid" id="formInsert" lay-filter="formInsert">
    <header>
        <div class="btnBar">
            <div class="btn-group btn-group-sm">
                <button class="btn_submit" lay-submit lay-filter="btn_submit">保存</button>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn_submit_new" lay-submit lay-filter="btn_submit_new">保存新增</button>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn_return">返回</button>
            </div>
        </div>
    </header>
    <main>
        <div class="form-row">
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">从机编码</label>
                    <div class="col-8">
                        <input class="form-control" name="slaveCode">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">从机名称</label>
                    <div class="col-8">
                        <input class="form-control" name="slaveName">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">从机IP地址</label>
                    <div class="col-8">
                        <input class="form-control" name="slaveIp" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">线圈名称</label>
                    <div class="col-8">
                        <input class="form-control" name="coilName" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">线圈数量</label>
                    <div class="col-8">
                        <input class="form-control" name="coilNum" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">离散量名称</label>
                    <div class="col-8">
                        <input class="form-control" name="discreteName" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">离散量数量</label>
                    <div class="col-8">
                        <input class="form-control" name="discreteNum" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">添加时间</label>
                    <div class="col-8">
                        <input class="form-control" readonly name="createTime">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">备注</label>
                    <div class="col-8">
                        <input class="form-control" name="remark">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">从机状态</label>
                    <div class="col-8">
                        <select class="form-control custom-select disabled" name="status" lay-ignore>
                            <option value="1" selected>启用</option>
                            <option value="2">停用</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="divInsert" id="bodyInsert">
            <table class="table table-bordered table-sm tableDiy" id="tableInsert">
                <thead class="thead-light">
                <tr>
                    <!--					<th class="btnRow">增行</th>-->
                    <th width="80">序号</th>
                    <th>关联设备类型</th>
                    <th>串口名称</th>
                    <th>排序</th>
                    <th>是否配置</th>
                    <th>添加时间</th>
                    <th>修改时间</th>
                    <!--					<th>操作</th>-->
                    <!--					<th class="btnRow">删行</th>-->
                </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </main>
</form>


<!--第三方js-->
<script src="_plugin/layui/layui.all.js"></script>
<script src="_plugin/layui/lay/modules/laydate.js"></script>
<script src="_plugin/jquery/jquery-3.3.1.min.js"></script>
<script src="_plugin/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="_plugin/zTree/js/jquery.ztree.core.min.js"></script>
<script src="_plugin/zj/zMath.js"></script>
<script src="_plugin/moment/moment.min.js"></script>
<!--自定义js-->
<script src="_js/main.js"></script>
<script>
    $('#check_showAll').change(function () {
        getTable()
    })

    //获取表格
    function getTable() {
        datasl.token = token
        datasl.status = $('#check_showAll').prop('checked') ? '' : 1
        laytable.render({
            elem: '#dataTable',
            url: '../adminx/slave/findAll.do',
            where: datasl,
            method: 'post',
            headers: {token: token},
            height: 'full-100',  //设定高度-差值
            cols: [[
                {width: 45, type: 'radio'},
                {
                    minWidth: 120, title: '从机ip地址',
                    templet: `<div><a href="##" class="btn_xiangqing">{{d.slaveIp}}</a></div>`
                },
                {minWidth: 120, title: '从机名称', field: 'slaveName'},
                {minWidth: 100, title: '从机编码', field: 'slaveCode'},
                {minWidth: 120, title: '线圈名称', field: 'coilName'},
                {minWidth: 120, title: '线圈数量', field: 'coilNum'},
                {minWidth: 120, title: '离散量名称', field: 'discreteName'},
                {minWidth: 120, title: '离散量数量', field: 'discreteNum'},
                {minWidth: 120, title: '添加时间', field: 'createTime'},
                {minWidth: 120, title: '备注', field: 'remark'},
                {
                    minWidth: 120, title: '从机状态',
                    templet: function (d) {
                        switch (d.status * 1) {
                            case 1:
                                d.status = '<span class="status_ok">启用</span>'
                                break
                            case 2:
                                d.status = '<span class="status_no">停用</span>'
                                break
                        }
                        return d.status
                    }
                },
            ]],
            page: {
                layout: ['prev', 'page', 'next', 'skip', 'count', 'limit'], //组件
                limits: [10, 20, 30, 50, 100, 150, 1000, 3000],  //每页展示条数
                limit: 20,  //默认每页展示条数
            },
            request: {
                pageName: 'page',    //页码的参数名称，默认：page
                limitName: 'pageSize'   //每页数据量的参数名，默认：limit
            },
            response: {
                statusCode: 1111  //规定成功状态码，table 组件默认为 0
            },
            parseData: function (res) { //表格渲染前的数据预处理
                return {
                    code: res.code,    //解析接口状态
                    msg: res.msg,      //解析提示文本,当code与statusCode不等(即失败)时提示
                    count: res.total,  //解析数据长度
                    data: res.data     //解析数据列表
                };
            },
            done: function (res) {
                done_table(res)   //加载表格后的处理
            }
        })
    }
</script>
<script>
    //获取详情
    function getDetail() {
        layform.val('formInsert', thistr)
        //当前表单数据(暂存, 修改页点击返回时判断是否有改动)(放在最后)
        thisform = layform.val('formInsert')
        console.log(thistr)
        $.post(
            '../adminx/slave/findDetail.do',
            {
                token,
                slaveId: thistr.id,
            },
            res => {
                if (res.code != 1111) {
                    layer.msg(res.msg)
                    return false
                }
                let data = res.data
                layform.val('formInsert', data)

                $('#tableInsert tbody').empty()
                data.forEach(function (item, i) {
                    addRow()
                    if (item.type != '2' && item.type != '3' && item.type != '5' && item.type != '6' || item.status != '1') {
                        $('#tableInsert tbody tr').eq(i).find('[data-id="btn_open"]').addClass('none')
                        $('#tableInsert tbody tr').eq(i).find('[data-id="btn_close"]').addClass('none')
                    }

                    $('#tableInsert tbody tr').eq(i).find('[data-id="type"]').val(item.type)  //关联设备类型
                    $('#tableInsert tbody tr').eq(i).find('[data-id="serialName"]').val(item.serialName)  //串口名称
                    $('#tableInsert tbody tr').eq(i).find('[data-id="serialSort"]').val(item.serialSort)  //排序
                    $('#tableInsert tbody tr').eq(i).find('[data-id="status"]').val(item.status)  //是否配置 （是/否）
                    $('#tableInsert tbody tr').eq(i).find('[data-id="createTime"]').val(item.createTime)  //创建时间
                    $('#tableInsert tbody tr').eq(i).find('[data-id="updateTime"]').val(item.updateTime)  //修改时间
                    $('#tableInsert tbody tr').eq(i).find('[data-id="slaveIp"]').val(item.slaveIp)  //从机IP地址


                })
                if ($('body').attr('thisdo') == 'detail') {  //禁用表单元素
                    $('#tableInsert tbody .form-control').prop('disabled', true)
                    $('#tableInsert tbody [data-id="btn_publish"]').removeClass('none')
                }


                //当前表单数据(暂存, 修改页点击返回时判断是否有改动)(放在最后)
                thisform = layform.val('formInsert')
            }
        )
    }


    function addRow(i) {
        let row = `<tr>
				<!--<td class="btnRow">
				<div class="divBtnRow btn_addRow"></div>
			</td>-->
				<td><input class="form-control disabled lineNumber" title="序号" disabled/></td>
				<td>
				<select class="form-control custom-select" data-id="type" lay-ignore title="关联设备类型" placeholder="*" lay-verify="required" lay-verType="tips">
				<option value="1">进端红外线1</option>
				<option value="7">进端红外线2</option>
				<option value="2">进端道闸(开)</option>
				<option value="9">进端道闸(关)</option>
				<option value="3">进端红绿灯</option>
				<option value="4">出端红外线1</option>
				<option value="8">出端红外线2</option>
				<option value="5">出端道闸(开)</option>
				<option value="10">出端道闸(关)</option>
				<option value="6">出端红绿灯</option>
				</select>
				</td>
				<td><input class="form-control" data-id="serialName" title="串口名称" placeholder="*" lay-verify="required" lay-verType="tips"/></td>
				<td><input class="form-control"  data-id="serialSort" title="排序" onkeyup="value=value.replace(/[^\\d]/g,'')"/>
				<input data-id="slaveIp" title="从机ip" /></td>
				<td><select class="form-control custom-select" data-id="status" title="是否配置" lay-ignore><option value="1" selected>是</option><option value="2">否</option></select></td>
				<td><input class="form-control disabled" disabled data-id="createTime" title="添加时间"/></td>
				<td><input class="form-control disabled" disabled data-id="updateTime" title="修改时间"/></td>
				<!--<td class="czBox"><a href="##" class="btn_open btnTds" data-id="btn_open">开启</a>
				<a href="##" class="btn_close btnTds" data-id="btn_close">关闭</a></td>-->
				<!--<td class="btnRow">
				<div class="divBtnRow btn_delRow"></div>
			</td>-->
				</tr>`
        if (i == null) {
            $('#tableInsert tbody').append(row)
        } else {
            $('#tableInsert tbody tr').eq(i).after(row)
        }
        $('#tableInsert tbody .lineNumber').each(function (i) { //更新行号
            $(this).val(i + 1)
        })
    }

    /*<td><select class="form-control custom-select" data-id="bankNameNo" placeholder="请选择" lay-verify="required" lay-verType="tips" lay-ignore>
    ${bankType}
    </select></td>*/

    //增行
    $('#tableInsert tbody').on('click', '.btn_addRow', function () {
        let i = $('#tableInsert tbody .btn_addRow').index($(this))
        addRow(i)
    })

    //删行
    $('#tableInsert tbody').on('click', '.btn_delRow', function () {
        if ($('#tableInsert tbody tr').length <= 1) {
            layer.msg('请至少保留一行')
            return false
        }
        $(this).parents('tr').remove()
        $('#tableInsert tbody .lineNumber').each(function (i) { //更新行号
            $(this).val(i + 1)
        })
    })

    //修改状态
    $('#tableInsert').on('click', '.btn_open', function () {
        let i = $(this).parents('tbody').find('.btn_publish.btnTd').index($(this))  //获取当前行序列
        thistr = thistable[i]

        console.log(thistr)
        let field = {
            token,
            slaveIp: $(this).parents('tr').find('[data-id="slaveIp"]').val(),    //
            sort: $(this).parents('tr').find('[data-id="serialSort"]').val(), // 设备排序
            status: true
        }
        console.log(field)
        $.post(
            '../adminx/slave/updateStatus.do',
            field,
            res => {
                if (res.code != 1111) {
                    layer.msg(res.msg)
                    return false
                }
                layer.msg(res.msg)
            }
        )
    })
    //修改状态
    $('#tableInsert').on('click', '.btn_close', function () {
        let i = $(this).parents('tbody').find('.btn_publish.btnTd').index($(this))  //获取当前行序列
        thistr = thistable[i]

        console.log(thistr)
        let field = {
            token,
            slaveIp: $(this).parents('tr').find('[data-id="slaveIp"]').val(),    //
            sort: $(this).parents('tr').find('[data-id="serialSort"]').val(), // 设备排序
            status: false
        }
        console.log(field)
        $.post(
            '../adminx/slave/updateStatus.do',
            field,
            res => {
                if (res.code != 1111) {
                    layer.msg(res.msg)
                    return false
                }
                layer.msg(res.msg)
            }
        )
    })
</script>
<script>
    //新增
    $('.btn_insert').click(function () {
        setTimeout(function () {
            $('#tableInsert tbody').empty()
        }, 100)
    })

    //删除
    $('.btn_delete').click(function () {
        let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
        if (!$('body').attr('thisdo')) {
            if (!checkeds.length) {
                layer.msg('请至少选择一条数据')
                return false
            }
        } else {
            checkeds = [thistr]
        }
        let ids = checkeds.map(item => item.id).join(',')
        layer.confirm(`删除后无法恢复，确定删除这${checkeds.length}条记录？`, {
            btn: ['确定', '取消'] //按钮
        }, function () {
            $.post(
                '../adminx/slave/deleteSlave.do',
                {
                    token,
                    id: ids,
                },
                res => {
                    done(res)   //常规操作后的处理
                }
            )
        })
    })

    //----------------------------------
    //修改
    $(document).on('click', '.btn_update', function () {
        if ($(this).attr('class').includes('btnTd')) { //行内按钮
            let i = $('.btn_update.btnTd').index($(this))
            thistr = thistable[i]
        } else {
            let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
            if (!$('body').attr('thisdo')) {
                if (!checkeds.length) {
                    layer.msg('请选择一条数据')
                    return false
                }
                if (checkeds.length > 1) {
                    layer.msg('每次只能修改一条数据')
                    return false
                }
                thistr = checkeds[0]
            }

        }
        to_update() //前往修改
    })

    //保存_执行 (表单内容, 按钮名称)
    function doSubmit(field, btn) {
        field.token = token
        let url = '../adminx/slave/addSlave.do'
        if ($('body').attr('thisdo') == 'update') {
            let jsonStr = []
            $('#tableInsert tbody tr').each(function () {
                jsonStr.push({
                    type: $(this).find('[data-id="type"]').val(),  //关联设备类型
                    serialName: $(this).find('[data-id="serialName"]').val(), //串口名称
                    serialSort: $(this).find('[data-id="serialSort"]').val(),  // 排序
                    status: $(this).find('[data-id="status"]').val(),   //是否配置
                    createTime: $(this).find('[data-id="createTime"]').val(),   //添加时间
                    updateTime: $(this).find('[data-id="updateTime"]').val()
                })
            })
            field.jsonStr = JSON.stringify(jsonStr)
            url = '../adminx/slave/updateSlave.do'
            // deleteField(thisform, field)  //修改传值只传变化的字段
            field.id = thistr.id
        }
        $.post(
            url,
            field,
            res => {
                done_submit(res, btn)   //保存后的处理
            }
        )
    }

    //启用
    $('.btn_active').click(function () {
        let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
        if (!$('body').attr('thisdo')) {
            if (!checkeds.length) {
                layer.msg('请选择一条数据')
                return false
            }
        } else {
            checkeds = [thistr]
        }
        let msg = ''
        checkeds.forEach(function (item) {
            if (item.status == 1) {
                msg = '已启用的数据无需启用'
                return false
            }
        })
        if (msg.length) {
            layer.msg(msg)
            return false
        }
        $.post(
            '../adminx/slave/updateSlave.do',
            {
                token,
                id: checkeds.map(item => item.id).join(','),
                status: 1
            },
            res => {
                done(res)   //常规操作后的处理
            }
        )
    })
    //停用
    $('.btn_freeze').click(function () {
        let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
        if (!$('body').attr('thisdo')) {
            if (!checkeds.length) {
                layer.msg('请选择一条数据')
                return false
            }
        } else {
            checkeds = [thistr]
        }
        let msg = ''
        checkeds.forEach(function (item) {
            if (item.status == 2) {
                msg = '已停用的数据无需停用'
                return false
            }
        })
        if (msg.length) {
            layer.msg(msg)
            return false
        }
        $.post(
            '../adminx/slave/updateSlave.do',
            {
                token,
                id: checkeds.map(item => item.id).join(','),
                status: 2
            },
            res => {
                done(res)   //常规操作后的处理
            }
        )
    })
</script>
</body>
</html>