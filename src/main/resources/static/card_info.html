<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <!--第三方css-->
    <link rel="stylesheet" href="_plugin/layui/css/layui.css">
    <link rel="stylesheet" href="_plugin/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="_plugin/zTree/css/bootstrapStyle/bootstrapStyle.css">

    <!--自定义css-->
    <link rel="stylesheet" href="_css/main.css">

</head>
<style>
    /*上传图片重写---------------------------------------------*/
    .imgBox {
        width: 60px;
        height: 60px;
        background-image: url("_img/main/upload.png");
    }

    .imgBox:not(.addImgs) {
        border: 1px #e5e5e5 solid;
    }

    body[thisdo="detail"] .addImgs {
        display: none;
    }

    .addImgs {
        width: 60px;
        height: 60px;
    }

    .btn_publish {
        line-height: 38px;
    }

    .btnTds {
        line-height: 35px;
    }
</style>
<body>
<!--主框架-->
<div class="bodyGrid">
    <header>
        <div class="btnBar">
            <div class="btn-group">
                <button class="btn btn-info btn_insert">新增</button>
                <button class="btn btn-info btn_update">修改</button>
                <button class="btn btn-info btn_delete">删除</button>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-info btn_select1">查询</button>
            </div>

        </div>
    </header>
    <main>
        <table class="layui-table" id="dataTable" lay-filter="dataTable"></table>
    </main>
</div>

<!--副框架-->
<form class="layui-form bodyGrid" id="formInsert" lay-filter="formInsert">
    <header>
        <div class="btnBar">
            <div class="btn-group btn-group-sm">
                <button class="btn_submit" lay-submit lay-filter="btn_submit">保存</button>
            </div>
            <div class="btn-group btn-group-sm">
                <button class="btn_return">返回</button>
            </div>
        </div>
    </header>
    <main>
        <div class="form-row">
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">序号</label>
                    <div class="col-8">
                        <input class="form-control" name="id">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">卡号</label>
                    <div class="col-8">
                        <input class="form-control" name="cardNum" lay-verify="required">
                        <!--                        <select class="form-control" name="cardNum" lay-verify="required">-->
                        <!--                        </select>-->
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">数据</label>
                    <div class="col-8">
                        <input class="form-control" name="data" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">数据类型</label>
                    <div class="col-8">
                        <!--                        <input class="form-control" name="dataType" lay-verify="required|dataType">-->
                        <select class="form-control" name="dataType" lay-verify="required">
                            <option value="供应商">供应商</option>
                            <option value="物料">物料</option>
                        </select>
                    </div>
                </div>
            </div>

        </div>
    </main>
</form>


<!--第三方js-->
<script src="_plugin/layui/layui.all.js"></script>
<script src="_plugin/layui/lay/modules/laydate.js"></script>
<script src="_plugin/jquery/jquery-3.3.1.min.js"></script>
<script src="_plugin/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="_plugin/zTree/js/jquery.ztree.core.min.js"></script>
<script src="_plugin/zj/zMath.js"></script>
<script src="_plugin/moment/moment.min.js"></script>
<!--自定义js-->
<script src="_js/main.js"></script>
<script>
    let queryUrl = 'admin/cardInfo/queryAll'
    let deleteUrl = 'admin/cardInfo/delete'
    let saveOrUpdateUrl = 'admin/cardInfo/saveOrUpdate'

    let cardList = []

    $('.btn_select1').click(function () {
        getTable()
    })

    /*websocket*/
    let ws_url = location.origin.replace('http', 'ws') + '/weightproject/websocket/socketServer.do?' + loginId
    // let ws_url = 'http://192.168.1.217:8080/weightproject/websocket/socketServer.do?userId=' + loginId
    let ws = null           //ws实例

    ws_init()
    setInterval(() => {   //20秒轮询
        if (ws.readyState == 1) {
            ws.send('heartCheck')   //正常则发送心跳
        } else {
            ws_init()   //断开则初始化
        }
    }, 20000)


    function ws_init() {    //初始化
        ws = new WebSocket(ws_url)
        ws.onopen = ws_onopen         //连接
        ws.onmessage = ws_onmessage   //接收
        // ws.onclose = ws_onclose       //断开
        // ws.onerror = ws_onerror       //错误
    }

    function ws_onopen() {
        console.log('ws连接成功')
    }

    function ws_onmessage(e) {
        console.log(e)

        let data = JSON.parse(e.data)
        //let result = JSON.parse(e.result)
        if (data.type == '1111') {  //初始信息(首次返回的消息)
            console.log('连接成功')
        } else if (data.type == 10) {
            $('.form-control[name="cardNum"]').text(data.data)
        }
    }


    //获取表格
    function getTable() {
        datasl.token = token
        laytable.render({
            elem: '#dataTable',
            url: queryUrl,
            where: datasl,
            method: 'post',
            headers: {token: token},
            height: 'full-100',  //设定高度-差值
            cols: [[
                {width: 45, type: 'radio'},
                {
                    minWidth: 120, title: '序号',
                    templet: `<div><a href="##" class="btn_xiangqing">{{d.id}}</a></div>`
                },
                {minWidth: 100, title: '卡号', field: 'cardNum'},
                {minWidth: 120, title: '数据', field: 'data'},
                {minWidth: 120, title: '数据类型', field: 'dataType'},
            ]],
            page: {
                layout: ['prev', 'page', 'next', 'skip', 'count', 'limit'], //组件
                limits: [10, 20, 30, 50, 100, 150, 1000, 3000],  //每页展示条数
                limit: 20,  //默认每页展示条数
            },
            request: {
                pageName: 'page',    //页码的参数名称，默认：page
                limitName: 'pageSize'   //每页数据量的参数名，默认：limit
            },
            response: {
                statusCode: 1111  //规定成功状态码，table 组件默认为 0
            },
            parseData: function (res) { //表格渲染前的数据预处理
                return {
                    code: res.code,    //解析接口状态
                    msg: res.msg,      //解析提示文本,当code与statusCode不等(即失败)时提示
                    count: res.total,  //解析数据长度
                    data: res.data     //解析数据列表
                };
            },
            done: function (res) {
                done_table(res)   //加载表格后的处理
            }
        })
    }

    //获取详情
    function getDetail() {
        layform.val('formInsert', thistr)
        //当前表单数据(暂存, 修改页点击返回时判断是否有改动)(放在最后)
        thisform = layform.val('formInsert')
        $('.form-control[name="id"]').prop('disabled', true)
        console.log(thistr)
    }

    function getItemList() {
        if (cardList.length === 0) {
            $.post(
                "admin/cardInfo/queryAll",
                {},
                res => {
                    cardList = res.data
                    cardList.forEach(card => {
                        $('.form-control[name="cardNum"]').append(
                            $('<option>').val(card.cardNum).text(card.cardNum)
                        )
                    })
                }
            )
        }
    }
</script>
<script>
    //新增
    $('.btn_insert').click(function () {
        $('.form-control[name="id"]').prop('disabled', true)
    })

    //删除
    $('.btn_delete').click(function () {
        let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
        if (!$('body').attr('thisdo')) {
            if (!checkeds.length) {
                layer.msg('请至少选择一条数据')
                return false
            }
        } else {
            checkeds = [thistr]
        }
        let ids = checkeds.map(item => item.id).join(',')
        layer.confirm(`删除后无法恢复，确定删除这${checkeds.length}条记录？`, {
            btn: ['确定', '取消'] //按钮
        }, function () {
            $.ajax(
                {
                    url: deleteUrl,
                    type: 'POST',
                    data: JSON.stringify({
                        token: token,
                        id: ids
                    }),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: res => {
                        done(res)   //常规操作后的处理
                    }
                }
            )
        })
    })

    //----------------------------------
    //修改
    $(document).on('click', '.btn_update', function () {
        if ($(this).attr('class').includes('btnTd')) { //行内按钮
            let i = $('.btn_update.btnTd').index($(this))
            thistr = thistable[i]
        } else {
            let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
            if (!$('body').attr('thisdo')) {
                if (!checkeds.length) {
                    layer.msg('请选择一条数据')
                    return false
                }
                if (checkeds.length > 1) {
                    layer.msg('每次只能修改一条数据')
                    return false
                }
                thistr = checkeds[0]
            }

        }
        to_update() //前往修改
    })

    //保存_执行 (表单内容, 按钮名称)
    function doSubmit(field, btn) {
        field.token = token
        $.ajax({
            url: saveOrUpdateUrl,
            type: 'POST',
            data: JSON.stringify(field),
            contentType: 'application/json',
            dataType: 'json',
            success: res => {
                done_submit(res, btn)
            }
        })
    }

    laydate.render({
        elem: '#startTime', //指定元素
        max: 0,
        type: 'datetime',
        trigger: 'click',
        value: moment().format('YYYY-MM-DD 00:00:00')
    })

    laydate.render({
        elem: '#endTime', //指定元素
        max: 0,
        type: 'datetime',
        trigger: 'click',
        value: new Date()
    })

    laydate.render({
        elem: '.form-control[name="weighDate"]', //指定元素
        max: 0,
        type: 'datetime',
        trigger: 'click'
    })
</script>
</body>
</html>