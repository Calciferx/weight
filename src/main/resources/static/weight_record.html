<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title></title>
    <!--第三方css-->
    <link rel="stylesheet" href="_plugin/layui/css/layui.css">
    <link rel="stylesheet" href="_plugin/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="_plugin/zTree/css/bootstrapStyle/bootstrapStyle.css">

    <!--自定义css-->
    <link rel="stylesheet" href="_css/main.css">

</head>
<style>
    /*上传图片重写---------------------------------------------*/
    .imgBox {
        width: 60px;
        height: 60px;
        background-image: url("_img/main/upload.png");
    }

    .imgBox:not(.addImgs) {
        border: 1px #e5e5e5 solid;
    }

    body[thisdo="detail"] .addImgs {
        display: none;
    }

    .addImgs {
        width: 60px;
        height: 60px;
    }

    .btn_publish {
        line-height: 38px;
    }

    .btnTds {
        line-height: 35px;
    }
</style>
<body>
<!--主框架-->
<div class="bodyGrid">
    <header>
        <div class="btnBar">
            <div class="btn-group">
                <button class="btn btn-info btn_insert">新增</button>
                <button class="btn btn-info btn_update">修改</button>
                <button class="btn btn-info btn_delete">删除</button>
            </div>
            <div class="btn-group searchBox">
                <input class="form-control" data-id="startTime" id="startTime" placeholder="请选择开始时间" readonly>
            </div>
            <div class="btn-group">至</div>
            <div class="btn-group searchBox">
                <input class="form-control" data-id="endTime" id="endTime" placeholder="请选择结束时间" readonly>
            </div>
            <div class="btn-group">
                <button class="btn btn-outline-info btn_select1">查询</button>
            </div>

        </div>
    </header>
    <main>
        <table class="layui-table" id="dataTable" lay-filter="dataTable"></table>
    </main>
</div>

<!--副框架-->
<form class="layui-form bodyGrid" id="formInsert" lay-filter="formInsert">
    <header>
        <div class="btnBar">
            <div class="btn-group btn-group-sm">
                <button class="btn_submit" lay-submit lay-filter="btn_submit">保存</button>
            </div>
            <!--            <div class="btn-group btn-group-sm">-->
            <!--                <button class="btn_submit_new" lay-submit lay-filter="btn_submit_new">保存新增</button>-->
            <!--            </div>-->
            <div class="btn-group btn-group-sm">
                <button class="btn_return">返回</button>
            </div>
        </div>
    </header>
    <main>
        <div class="form-row">
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">序号</label>
                    <div class="col-8">
                        <input class="form-control" name="id">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">检斤编号</label>
                    <div class="col-8">
                        <input class="form-control" name="weighId" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">供应商名称</label>
                    <div class="col-8">
                        <!--                        <input class="form-control" name="supplierName" lay-verify="required">-->
                        <select class="form-control" name="supplierName" lay-verify="required">

                        </select>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">物料名称</label>
                    <div class="col-8">
                        <!--                        <input class="form-control" name="materialName" lay-verify="required">-->
                        <select class="form-control" name="materialName" lay-verify="required"></select>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">车牌号</label>
                    <div class="col-8">
                        <!--                        <input class="form-control" name="plateNumber" lay-verify="required">-->
                        <select class="form-control" name="plateNumber" lay-verify="required"></select>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">毛重(KG)</label>
                    <div class="col-8">
                        <input class="form-control" name="roughWeight" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">皮重(KG)</label>
                    <div class="col-8">
                        <input class="form-control" name="tareWeight" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">净重(KG)</label>
                    <div class="col-8">
                        <input class="form-control" name="netWeight" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">检斤员</label>
                    <div class="col-8">
                        <!--                        <input class="form-control" name="weighMan" lay-verify="required">-->
                        <select class="form-control" name="weighMan" lay-verify="required"></select>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">检斤状态</label>
                    <div class="col-8">
                        <input class="form-control" name="weighStatus" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">检斤日期</label>
                    <div class="col-8">
                        <input class="form-control" name="weighDate" lay-verify="required">
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">受控编号</label>
                    <div class="col-8">
                        <!--                        <input class="form-control" name="controlId" lay-verify="required">-->
                        <select class="form-control" name="controlId" lay-verify="required">
                            <option value="Q/CHALCO-GS-910351-JL057-2019 ">Q/CHALCO-GS-910351-JL057-2019</option>
                            <option value="Q/CHALCO-GS-910351-JL017-2019 ">Q/CHALCO-GS-910351-JL017-2019</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">是否化验</label>
                    <div class="col-8">
                        <!--                        <input class="form-control" name="isTest" lay-verify="required">-->
                        <select class="form-control" name="isTest" lay-verify="required">
                            <option value="是         ">是</option>
                            <option value="否         ">否</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-6">
                <div class="form-group form-row">
                    <label class="col-4 col-form-label">备注</label>
                    <div class="col-8">
                        <input class="form-control" name="comment">
                    </div>
                </div>
            </div>
        </div>
    </main>
</form>


<!--第三方js-->
<script src="_plugin/layui/layui.all.js"></script>
<script src="_plugin/layui/lay/modules/laydate.js"></script>
<script src="_plugin/jquery/jquery-3.3.1.min.js"></script>
<script src="_plugin/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="_plugin/zTree/js/jquery.ztree.core.min.js"></script>
<script src="_plugin/zj/zMath.js"></script>
<script src="_plugin/moment/moment.min.js"></script>
<!--自定义js-->
<script src="_js/main.js"></script>
<script>
    let queryUrl = 'admin/weightRecord/query'
    let deleteUrl = 'admin/weightRecord/delete'
    let saveOrUpdateUrl = 'admin/weightRecord/saveOrUpdate'

    let supplierList = []
    let materialList = []
    let carList = []
    let userList = []


    laydate.render({
        elem: '#startTime', //指定元素
        max: 0,
        type: 'datetime',
        trigger: 'click',
        value: moment().format('YYYY-MM-DD 00:00:00')
    })

    laydate.render({
        elem: '#endTime', //指定元素
        max: 0,
        type: 'datetime',
        trigger: 'click',
        value: new Date()
    })

    laydate.render({
        elem: '.form-control[name="weighDate"]', //指定元素
        max: 0,
        type: 'datetime',
        trigger: 'click'
    })

    datasl.startTime = "2024-09-07 00:00:00"
    datasl.endTime = "2024-10-07 00:00:00"
    // 填充表单中的下拉菜单
    getItemList()

    $('.btn_select1').click(function () {
        datasl.startTime = $('.searchBox [data-id="startTime"]').val()
        datasl.endTime = $('.searchBox [data-id="endTime"]').val()
        getTable()
    })

    //获取表格
    function getTable() {
        datasl.token = token
        laytable.render({
            elem: '#dataTable',
            url: queryUrl,
            where: datasl,
            method: 'post',
            headers: {token: token},
            height: 'full-100',  //设定高度-差值
            cols: [[
                {width: 45, type: 'radio'},
                {
                    minWidth: 80, title: '序号',
                    templet: `<div><a href="##" class="btn_xiangqing">{{d.id}}</a></div>`
                },
                {minWidth: 120, title: '检斤编号', field: 'weighId'},
                {minWidth: 150, title: '供应商名称', field: 'supplierName'},
                {minWidth: 120, title: '物料名称', field: 'materialName'},
                {minWidth: 120, title: '车牌号', field: 'plateNumber'},
                {minWidth: 120, title: '毛重(KG)', field: 'roughWeight'},
                {minWidth: 120, title: '皮重(KG)', field: 'tareWeight'},
                {minWidth: 120, title: '净重(KG)', field: 'netWeight'},
                {minWidth: 120, title: '检斤员', field: 'weighMan'},
                {minWidth: 120, title: '检斤状态', field: 'weighStatus'},
                {minWidth: 120, title: '检斤日期', field: 'weighDate'},
                {minWidth: 120, title: '受控编号', field: 'controlId'},
                {minWidth: 120, title: '是否化验', field: 'isTest'},
                {minWidth: 120, title: '备注', field: 'comment'},
            ]],
            page: {
                layout: ['prev', 'page', 'next', 'skip', 'count', 'limit'], //组件
                limits: [10, 20, 30, 50, 100, 150, 1000, 3000],  //每页展示条数
                limit: 20,  //默认每页展示条数
            },
            request: {
                pageName: 'page',    //页码的参数名称，默认：page
                limitName: 'pageSize'   //每页数据量的参数名，默认：limit
            },
            response: {
                statusCode: 1111  //规定成功状态码，table 组件默认为 0
            },
            parseData: function (res) { //表格渲染前的数据预处理
                return {
                    code: res.code,    //解析接口状态
                    msg: res.msg,      //解析提示文本,当code与statusCode不等(即失败)时提示
                    count: res.total,  //解析数据长度
                    data: res.data     //解析数据列表
                };
            },
            done: function (res) {
                done_table(res)   //加载表格后的处理
            }
        })
    }

    //获取详情
    function getDetail() {
        layform.val('formInsert', thistr)
        //当前表单数据(暂存, 修改页点击返回时判断是否有改动)(放在最后)
        thisform = layform.val('formInsert')
        $('.form-control[name="id"]').prop('disabled', true)
        console.log(thistr)
    }

    function getItemList() {
        if (supplierList.length === 0) {
            $.post(
                "admin/supplierInfo/queryAll",
                {},
                res => {
                    supplierList = res.data
                    supplierList.forEach(supplier => {
                        $('.form-control[name="supplierName"]').append(
                            $('<option>').val(supplier.supplierName).text(supplier.supplierName)
                        )
                    })
                }
            )
        }
        if (materialList.length === 0) {
            $.post(
                "admin/material/queryAll",
                {},
                res => {
                    materialList = res.data
                    materialList.forEach(material => {
                        $('.form-control[name="materialName"]').append(
                            $('<option>').val(material.materialName).text(material.materialName)
                        )
                    })
                }
            )
        }
        if (carList.length === 0) {
            $.post(
                "admin/car/queryAll",
                {},
                res => {
                    carList = res.data
                    carList.forEach(car => {
                        $('.form-control[name="plateNumber"]').append(
                            $('<option>').val(car.plateNumber).text(car.plateNumber)
                        )
                    })
                }
            )
        }
        if (userList.length === 0) {
            $.post(
                "admin/user/queryAll",
                {},
                res => {
                    userList = res.data
                    userList.forEach(user => {
                        $('.form-control[name="weighMan"]').append(
                            $('<option>').val(user.realName).text(user.realName)
                        )
                    })
                }
            )
        }
    }
</script>
<script>
    //新增
    $('.btn_insert').click(function () {
        $('.form-control[name="id"]').prop('disabled', true)
    })

    //删除
    $('.btn_delete').click(function () {
        let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
        if (!$('body').attr('thisdo')) {
            if (!checkeds.length) {
                layer.msg('请至少选择一条数据')
                return false
            }
        } else {
            checkeds = [thistr]
        }
        let ids = checkeds.map(item => item.id).join(',')
        layer.confirm(`删除后无法恢复，确定删除这${checkeds.length}条记录？`, {
            btn: ['确定', '取消'] //按钮
        }, function () {
            $.ajax(
                {
                    url: deleteUrl,
                    type: 'POST',
                    data: JSON.stringify({
                        token: token,
                        id: ids
                    }),
                    contentType: 'application/json',
                    dataType: 'json',
                    success: res => {
                        done(res)   //常规操作后的处理
                    }
                }
            )
        })
    })

    //----------------------------------
    //修改
    $(document).on('click', '.btn_update', function () {
        if ($(this).attr('class').includes('btnTd')) { //行内按钮
            let i = $('.btn_update.btnTd').index($(this))
            thistr = thistable[i]
        } else {
            let checkeds = laytable.checkStatus('dataTable').data  //获取选中数据(复选框)
            if (!$('body').attr('thisdo')) {
                if (!checkeds.length) {
                    layer.msg('请选择一条数据')
                    return false
                }
                if (checkeds.length > 1) {
                    layer.msg('每次只能修改一条数据')
                    return false
                }
                thistr = checkeds[0]
            }

        }
        to_update() //前往修改
    })

    //保存_执行 (表单内容, 按钮名称)
    function doSubmit(field, btn) {
        field.token = token
        let url = saveOrUpdateUrl
        $.ajax({
            url: url,
            type: 'POST',
            data: JSON.stringify(field),
            contentType: 'application/json',
            dataType: 'json',
            success: res => {
                done_submit(res, btn)
            }
        })
    }

</script>
</body>
</html>